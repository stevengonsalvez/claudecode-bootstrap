name: Toolkit Validation

on:
  push:
    paths:
      - 'toolkit/**'
  pull_request:
    paths:
      - 'toolkit/**'

jobs:
  validate-packages:
    name: Validate Packages Structure
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd toolkit
          npm install

      - name: Validate package structure
        run: |
          cd toolkit

          echo "=== Checking packages/ structure ==="

          # Required directories
          for dir in agents skills workflows utilities; do
            if [ ! -d "packages/$dir" ]; then
              echo "ERROR: Missing required directory: packages/$dir"
              exit 1
            fi
            echo "✓ packages/$dir exists"
          done

          # Count files
          AGENT_COUNT=$(find packages/agents -name "*.md" | wc -l)
          SKILL_COUNT=$(find packages/skills -type f | wc -l)
          CMD_COUNT=$(find packages -path "*/commands/*.md" | wc -l)

          echo ""
          echo "File counts:"
          echo "  Agents: $AGENT_COUNT"
          echo "  Skills: $SKILL_COUNT"
          echo "  Commands: $CMD_COUNT"

          # Minimum thresholds
          [ "$AGENT_COUNT" -lt 30 ] && echo "WARNING: Agent count seems low" && exit 1
          [ "$CMD_COUNT" -lt 35 ] && echo "WARNING: Command count seems low" && exit 1

          echo "✓ Package structure validated"

  test-installations:
    name: Test Tool Installations
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tool: [claude-code-4.5, codex, gemini]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd toolkit
          npm install

      - name: Test ${{ matrix.tool }} installation
        run: |
          cd toolkit
          mkdir -p /tmp/test-${{ matrix.tool }}

          echo "Installing ${{ matrix.tool }}..."
          node create-rule.js --tool=${{ matrix.tool }} --targetFolder=/tmp/test-${{ matrix.tool }} --yes

          # Verify installation
          TARGET_DIR="/tmp/test-${{ matrix.tool }}/.${{ matrix.tool == 'claude-code-4.5' && 'claude' || matrix.tool }}"

          if [ ! -d "$TARGET_DIR" ]; then
            echo "ERROR: Installation directory not created"
            exit 1
          fi

          # Count installed files
          FILE_COUNT=$(find "$TARGET_DIR" -type f | wc -l)
          echo "Installed $FILE_COUNT files to $TARGET_DIR"

          # Minimum file count check
          [ "$FILE_COUNT" -lt 100 ] && echo "ERROR: Too few files installed" && exit 1

          # Check for required components
          [ ! -d "$TARGET_DIR/agents" ] && echo "ERROR: agents/ missing" && exit 1
          [ ! -d "$TARGET_DIR/commands" ] && echo "ERROR: commands/ missing" && exit 1

          echo "✓ ${{ matrix.tool }} installation validated"

  check-template-substitution:
    name: Check Template Substitution
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd toolkit
          npm install

      - name: Test template substitution
        run: |
          cd toolkit
          mkdir -p /tmp/test-templates

          # Install claude-code-4.5
          node create-rule.js --tool=claude-code-4.5 --targetFolder=/tmp/test-templates --yes

          # Check that {{TOOL_DIR}} and {{HOME_TOOL_DIR}} are replaced
          UNSUBSTITUTED=$(grep -r "{{TOOL_DIR}}\|{{HOME_TOOL_DIR}}" /tmp/test-templates/.claude/ 2>/dev/null | wc -l)

          if [ "$UNSUBSTITUTED" -gt 0 ]; then
            echo "ERROR: Found $UNSUBSTITUTED unsubstituted template variables"
            grep -r "{{TOOL_DIR}}\|{{HOME_TOOL_DIR}}" /tmp/test-templates/.claude/ | head -10
            exit 1
          fi

          echo "✓ All template variables substituted correctly"

  check-claude-code-thin-layer:
    name: Verify claude-code-4.5 is thin layer
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check claude-code-4.5 structure
        run: |
          cd toolkit/claude-code-4.5

          echo "=== Checking claude-code-4.5 is a thin layer ==="

          # Should only have these files
          ALLOWED_FILES="CLAUDE.md settings.json settings.local.json .gitignore"
          ALLOWED_DIRS="session logs"

          # Check for unexpected directories (agents, commands, etc should NOT exist)
          for dir in agents commands hooks skills templates utils orchestration output-styles reflections; do
            if [ -d "$dir" ]; then
              echo "ERROR: claude-code-4.5/$dir should not exist (content is in packages/)"
              exit 1
            fi
          done

          # Verify required files exist
          [ ! -f "CLAUDE.md" ] && echo "ERROR: CLAUDE.md missing" && exit 1
          [ ! -f "settings.json" ] && echo "ERROR: settings.json missing" && exit 1

          echo "✓ claude-code-4.5 is correctly structured as a thin layer"
